# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on pull request
on: pull_request
permissions:
  checks: write        # Required for Firebase action to create check runs
  contents: read
  pull-requests: write
  security-events: read  # Required for CodeQL integration

# Cancel previous runs when new commits are pushed
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build_and_preview:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NODE_ENV: production
          VITE_API_URL: https://api.missionctrl.org
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
      
      - name: Check if Firebase secret is configured
        id: check_secret
        run: |
          if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "secret_configured=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Firebase service account secret is not configured"
          else
            echo "secret_configured=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Firebase service account secret is configured"
          fi
      
      - name: Deploy to Firebase Hosting Preview
        id: firebase_deploy
        if: steps.check_secret.outputs.secret_configured == 'true'
        continue-on-error: true  # Known issue: action fails to parse expireTime even when deployment succeeds
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: groundctrl-c8860
          channelId: pr-${{ github.event.pull_request.number }}-fix
      
      - name: Extract deployment URL
        id: extract_url
        if: steps.check_secret.outputs.secret_configured == 'true'
        run: |
          # Extract URL from Firebase action output (if available)
          if [ -n "${{ steps.firebase_deploy.outputs.details_url }}" ]; then
            echo "preview_url=${{ steps.firebase_deploy.outputs.details_url }}" >> $GITHUB_OUTPUT
            echo "deployment_status=success" >> $GITHUB_OUTPUT
          else
            echo "preview_url=https://groundctrl-c8860.web.app" >> $GITHUB_OUTPUT
            echo "deployment_status=unknown" >> $GITHUB_OUTPUT
          fi
      
      - name: Install Playwright browsers (for E2E tests)
        if: steps.check_secret.outputs.secret_configured == 'true' && steps.extract_url.outputs.deployment_status == 'success'
        working-directory: ./frontend
        run: npx playwright install --with-deps
        continue-on-error: true
      
      - name: Run E2E tests for ${{ matrix.browser }} against deployed preview
        if: steps.check_secret.outputs.secret_configured == 'true' && steps.extract_url.outputs.deployment_status == 'success'
        working-directory: ./frontend
        run: npx playwright test --project="${{ matrix.browser }}"
        continue-on-error: true
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: ${{ steps.extract_url.outputs.preview_url }}
          SKIP_WEBSERVER: true
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY || 'test-api-key' }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN || 'test.firebaseapp.com' }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID || 'test-project' }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET || 'test.appspot.com' }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID || '123456789' }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID || 'test-app-id' }}
      
      - name: Upload E2E test results for ${{ matrix.browser }}
        if: always() && steps.check_secret.outputs.secret_configured == 'true'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: e2e-test-results-${{ matrix.browser }}-pr-${{ github.event.pull_request.number }}
          path: frontend/test-results/
          retention-days: 7
      
      - name: Comment on PR - E2E Test Results (${{ matrix.browser }})
        if: always() && steps.check_secret.outputs.secret_configured == 'true' && steps.extract_url.outputs.deployment_status == 'success'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.extract_url.outputs.preview_url }}';
            const browser = '${{ matrix.browser }}';
            const status = '${{ job.status }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            const body = `${emoji} **E2E Tests on ${browser}**

            üîó **Preview URL:** ${url}
            üåê **Browser:** ${browser}
            üìä **Status:** ${status === 'success' ? 'Passed' : 'Failed'}

            üîç **Workflow:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            üì¶ **Commit:** \`${context.sha.substring(0, 7)}\``;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Comment on PR - Deployment Skipped
        if: steps.check_secret.outputs.secret_configured == 'false'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è **Firebase Hosting Preview Skipped**\n\nThe Firebase service account secret (`FIREBASE_SERVICE_ACCOUNT`) is not configured in this repository.\n\n**To enable preview deployments:**\n1. Add the secret in [Repository Settings ‚Üí Secrets and variables ‚Üí Actions](/${{ github.repository }}/settings/secrets/actions)\n2. See `PRODUCTION_DEPLOYMENT.md` for instructions\n\n**Build Status:** ‚úÖ Frontend built successfully'
            })
      
      - name: Comment on PR - Deployment Failed
        if: failure() && steps.check_secret.outputs.secret_configured == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const body = `‚ùå **Firebase Hosting Preview Failed**

            The deployment to Firebase Hosting encountered an error.

            üìä **Status:**
            - **Build Status:** ‚úÖ Frontend built successfully
            - **Deploy Status:** ‚ùå Deployment failed

            üîç **Troubleshooting:**
            1. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for error details
            2. Verify Firebase service account has proper permissions
            3. Ensure Firebase project is active and billing is enabled
            4. Check if preview channels are enabled in Firebase Console

            üìö **Resources:**
            - See \`PRODUCTION_DEPLOYMENT.md\` for deployment guidelines
            - [Firebase Hosting Documentation](https://firebase.google.com/docs/hosting)

            **Commit:** \`${context.sha.substring(0, 7)}\``;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
