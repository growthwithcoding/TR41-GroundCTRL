# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR
on: pull_request
permissions:
  checks: write        # Required for Firebase action to create check runs
  contents: read
  pull-requests: write

# Cancel previous runs when new commits are pushed
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build_and_preview:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
      
      - name: Check if Firebase secret is configured
        id: check_secret
        run: |
          if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "secret_configured=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Firebase service account secret is not configured"
          else
            echo "secret_configured=true" >> $GITHUB_OUTPUT
            echo "âœ… Firebase service account secret is configured"
          fi
      
      - name: Deploy to Firebase Hosting Preview
        id: firebase_deploy
        if: steps.check_secret.outputs.secret_configured == 'true'
        continue-on-error: true  # Known issue: action fails to parse expireTime even when deployment succeeds
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: groundctrl-c8860
          channelId: pr-${{ github.event.pull_request.number }}-fix
      
      - name: Extract deployment URL
        id: extract_url
        if: steps.check_secret.outputs.secret_configured == 'true'
        run: |
          # Extract URL from Firebase action output (if available)
          if [ -n "${{ steps.firebase_deploy.outputs.details_url }}" ]; then
            echo "preview_url=${{ steps.firebase_deploy.outputs.details_url }}" >> $GITHUB_OUTPUT
            echo "deployment_status=success" >> $GITHUB_OUTPUT
          else
            echo "preview_url=https://groundctrl-c8860.web.app" >> $GITHUB_OUTPUT
            echo "deployment_status=unknown" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment on PR - Deployment Success
        if: steps.check_secret.outputs.secret_configured == 'true' && steps.extract_url.outputs.deployment_status == 'success'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const url = '${{ steps.extract_url.outputs.preview_url }}';
            const body = `âœ… **Firebase Hosting Preview Deployed Successfully!**

            ğŸ”— **Preview URL:** ${url}

            ğŸ“Š **Deployment Details:**
            - **Build Status:** âœ… Success
            - **Deploy Status:** âœ… Success
            - **Channel:** \`pr-${{ github.event.pull_request.number }}-fix\`
            - **Commit:** \`${context.sha.substring(0, 7)}\`

            ğŸ” **Workflow:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ---
            *This preview will expire in 7 days*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: Comment on PR - Deployment Skipped
        if: steps.check_secret.outputs.secret_configured == 'false'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ **Firebase Hosting Preview Skipped**\n\nThe Firebase service account secret (`FIREBASE_SERVICE_ACCOUNT`) is not configured in this repository.\n\n**To enable preview deployments:**\n1. Add the secret in [Repository Settings â†’ Secrets and variables â†’ Actions](/${{ github.repository }}/settings/secrets/actions)\n2. See `PRODUCTION_DEPLOYMENT.md` for instructions\n\n**Build Status:** âœ… Frontend built successfully'
            })
      
      - name: Comment on PR - Deployment Failed
        if: failure() && steps.check_secret.outputs.secret_configured == 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const body = `âŒ **Firebase Hosting Preview Failed**

            The deployment to Firebase Hosting encountered an error.

            ğŸ“Š **Status:**
            - **Build Status:** âœ… Frontend built successfully
            - **Deploy Status:** âŒ Deployment failed

            ğŸ” **Troubleshooting:**
            1. Check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for error details
            2. Verify Firebase service account has proper permissions
            3. Ensure Firebase project is active and billing is enabled
            4. Check if preview channels are enabled in Firebase Console

            ğŸ“š **Resources:**
            - See \`PRODUCTION_DEPLOYMENT.md\` for deployment guidelines
            - [Firebase Hosting Documentation](https://firebase.google.com/docs/hosting)

            **Commit:** \`${context.sha.substring(0, 7)}\``;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
