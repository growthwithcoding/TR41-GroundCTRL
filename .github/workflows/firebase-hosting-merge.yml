# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main

# Only run one production deployment at a time
concurrency:
  group: production-deployment
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  pull-requests: write
  security-events: read  # Required for CodeQL integration

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
        env:
          NODE_ENV: production
          VITE_API_URL: https://api.missionctrl.org
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
      
      - name: Verify build output
        working-directory: ./frontend
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Error: dist directory not found"
            exit 1
          fi
          echo "âœ… Build output verified"
          echo "ðŸ“¦ Build size: $(du -sh dist | cut -f1)"
      
      - name: Deploy to Firebase Hosting (Production)
        id: firebase_deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: groundctrl-c8860
      
      - name: Extract deployment URL
        id: extract_url
        if: success()
        run: |
          echo "production_url=https://groundctrl-c8860.web.app" >> $GITHUB_OUTPUT
          echo "deployment_time=$(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_OUTPUT
      
      - name: Create deployment success comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const commit = context.payload.head_commit;
            const body = `ðŸš€ **Production Deployment Successful!**

            ðŸ”— **Live URL:** ${{ steps.extract_url.outputs.production_url }}

            ðŸ“Š **Deployment Details:**
            - **Status:** âœ… Deployed to production
            - **Branch:** \`${context.ref.replace('refs/heads/', '')}\`
            - **Commit:** [\`${context.sha.substring(0, 7)}\`](${{ github.server_url }}/${{ github.repository }}/commit/${context.sha})
            - **Time:** ${{ steps.extract_url.outputs.deployment_time }}
            - **Triggered by:** @${context.actor}

            ðŸ“ **Commit Message:**
            > ${commit?.message || 'N/A'}

            ðŸ” **Workflow:** [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            // Try to find related PR and comment there
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });

            const relatedPR = prs.find(pr => 
              pr.merge_commit_sha === context.sha || 
              pr.merged_at && new Date(pr.merged_at) > new Date(Date.now() - 300000) // within last 5 minutes
            );

            if (relatedPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: relatedPR.number,
                body: body
              });
              console.log(`âœ… Posted deployment success to PR #${relatedPR.number}`);
            } else {
              console.log('â„¹ï¸ No recent PR found to comment on');
            }
      
      - name: Create GitHub Issue on Deployment Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const commit = context.payload.head_commit;
            const failedStep = '${{ job.status }}';
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Production Deployment Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## ðŸ”´ Production Deployment Failure

            **âš ï¸ URGENT: Production deployment has failed and requires immediate attention.**

            ### ðŸ“‹ Deployment Information
            - **Workflow Run:** [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - **Branch:** \`${context.ref.replace('refs/heads/', '')}\`
            - **Commit:** [\`${context.sha.substring(0, 7)}\`](${{ github.server_url }}/${{ github.repository }}/commit/${context.sha})
            - **Triggered by:** @${context.actor}
            - **Time:** ${new Date().toISOString()}
            - **Status:** ${failedStep}

            ### ðŸ“ Commit Details
            **Message:** ${commit?.message || 'N/A'}
            **Author:** ${commit?.author?.name || 'N/A'}

            ### ðŸ” Troubleshooting Steps

            1. **Review Workflow Logs**
               - Check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for specific error messages
               - Look for build failures, authentication issues, or deployment errors

            2. **Verify Configuration**
               - Ensure \`FIREBASE_SERVICE_ACCOUNT\` secret is properly configured
               - Verify the secret has not expired and has proper permissions
               - Check Firebase project status and billing

            3. **Check Build**
               - Verify frontend build completes successfully
               - Check for any dependency issues or breaking changes
               - Ensure \`dist\` directory is created

            4. **Firebase Console**
               - Check [Firebase Console](https://console.firebase.google.com/project/groundctrl-c8860)
               - Verify project is active and hosting is enabled
               - Check for any service disruptions

            ### ðŸ“š Resources
            - See \`PRODUCTION_DEPLOYMENT.md\` for deployment guidelines
            - [Firebase Hosting Documentation](https://firebase.google.com/docs/hosting)
            - [GitHub Actions Troubleshooting](https://docs.github.com/en/actions/monitoring-and-troubleshooting-workflows)

            ### âœ… Resolution Checklist
            - [ ] Reviewed workflow logs and identified root cause
            - [ ] Fixed the underlying issue
            - [ ] Tested changes locally or in preview
            - [ ] Re-run deployment or merge fix
            - [ ] Verified production site is working
            - [ ] Close this issue

            ---
            **Assigned to:** @${context.actor}`,
              labels: ['deployment-failure', 'urgent', 'production', 'bug'],
              assignees: [context.actor]
            });
            
            console.log(`âœ… Created issue #${issue.data.number}`);
            
            // Try to comment on related PR if exists
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 10
            });

            const relatedPR = prs.find(pr => 
              pr.merge_commit_sha === context.sha || 
              pr.merged_at && new Date(pr.merged_at) > new Date(Date.now() - 300000)
            );

            if (relatedPR) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: relatedPR.number,
                body: `ðŸ”´ **Production deployment failed!**\n\nAn issue has been created: #${issue.data.number}\nPlease review the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.`
              });
              console.log(`âœ… Posted failure notice to PR #${relatedPR.number}`);
            }
