# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Build frontend
        working-directory: ./frontend
        run: npm run build
      
      - name: Deploy to Firebase Hosting (Production)
        id: firebase_deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: groundctrl-c8860
      
      - name: Create GitHub Issue on Deployment Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Production Deployment Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Production Deployment Failure\n\n**Workflow Run:** [View Logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n\n**Branch:** \`${context.ref}\`\n**Commit:** ${context.sha}\n**Commit Message:** ${context.payload.head_commit?.message || 'N/A'}\n\n**Build Status:** ${context.job.status}\n\n### Actions Required:\n1. Review the workflow logs for error details\n2. Check if Firebase service account secret is properly configured\n3. Verify the build completed successfully\n4. Check Firebase Console for any project issues\n\n### Troubleshooting:\n- Ensure \`FIREBASE_SERVICE_ACCOUNT\` secret is configured\n- Verify the secret has proper permissions\n- Check that the Firebase project is active\n- Review recent changes in the commit\n\nSee \`PRODUCTION_DEPLOYMENT.md\` for deployment guidelines.`,
              labels: ['deployment-failure', 'urgent', 'production']
            })
            console.log(`Created issue #${issue.data.number}`)
